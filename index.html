<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Repository</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/js/fontawesome.min.js" defer></script>
</head>
<body class="h-screen bg-gray-100">
    <div class="max-w-4xl mx-auto p-4 mt-6 bg-white rounded-lg shadow-md">
        <h1 class="text-3xl font-bold mb-4">GitHub Repository</h1>
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <h2 class="text-xl font-bold mb-2">Select Repository</h2>
                <select id="repo-select" class="block w-full p-2 mb-4 border border-gray-300 rounded-md">
                    <option value="repo-1">Repository 1</option>
                    <option value="repo-2">Repository 2</option>
                </select>
            </div>
            <div class="flex-1">
                <h2 class="text-xl font-bold mb-2">Actions</h2>
                <button id="view-button" class="block w-full p-2 mb-2 bg-blue-500 hover:bg-blue-700 text-white font-bold rounded-md">
                    <i class="fas fa-eye"></i> View
                </button>
                <button id="download-button" class="block w-full p-2 mb-2 bg-green-500 hover:bg-green-700 text-white font-bold rounded-md">
                    <i class="fas fa-download"></i> Download App
                    <i id="download-loader" class="fas fa-spinner fa-spin text-gray-300 hidden"></i>
                </button>
            </div>
        </div>
    </div>
    <script>
        const token = process.env.Token;
        const repoSelect = document.getElementById('repo-select');
        const viewButton = document.getElementById('view-button');
        const downloadButton = document.getElementById('download-button');
        const downloadLoader = document.getElementById('download-loader');

        viewButton.addEventListener('click', async () => {
            const repo = repoSelect.value;
            const url = `https://api.github.com/repos/${repo}`;
            const response = await fetch(url, {
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            });
            const data = await response.json();
            window.open(data.html_url, '_blank');
        });

        downloadButton.addEventListener('click', async () => {
            const repo = repoSelect.value;
            const url = `https://api.github.com/repos/${repo}/releases`;
            downloadLoader.classList.remove('hidden');
            try {
                const response = await fetch(url, {
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                });
                const releases = await response.json();
                if (releases.length > 0) {
                    const latestRelease = releases[0];
                    const assets = latestRelease.assets;
                    const apkAsset = assets.find(asset => asset.name.endsWith('.apk'));
                    if (apkAsset) {
                        window.open(apkAsset.browser_download_url, '_blank');
                    } else {
                        const treeUrl = `https://api.github.com/repos/${repo}/git/trees/main`;
                        const treeResponse = await fetch(treeUrl, {
                            headers: {
                                Authorization: `Bearer ${token}`,
                            },
                        });
                        const treeData = await treeResponse.json();
                        const apkFile = treeData.tree.find(file => file.path.endsWith('.apk'));
                        if (apkFile) {
                            const blobUrl = `https://github.com/${repo}/raw/main/${apkFile.path}`;
                            window.open(blobUrl, '_blank');
                        } else {
                            alert('No APK file found in the repository.');
                        }
                    }
                } else {
                    const treeUrl = `https://api.github.com/repos/${repo}/git/trees/main`;
                    const treeResponse = await fetch(treeUrl, {
                        headers: {
                            Authorization: `Bearer ${token}`,
                        },
                    });
                    const treeData = await treeResponse.json();
                    const apkFile = treeData.tree.find(file => file.path.endsWith('.apk'));
                    if (apkFile) {
                        const blobUrl = `https://github.com/${repo}/raw/main/${apkFile.path}`;
                        window.open(blobUrl, '_blank');
                    } else {
                        alert('No APK file found in the repository.');
                    }
                }
            } catch (error) {
                console.error(error);
                alert('Error occurred while fetching data.');
            } finally {
                downloadLoader.classList.add('hidden');
            }
        });
    </script>
</body>
</html>